# ë¸”ë¡ í•„í„°ë§ v1.5 - Jackson ì‹œë¦¬ì–¼ë¼ì´ì € êµ¬í˜„

## ğŸ“‹ ê°œìš”

**ì‹¤ì œ êµ¬í˜„ëœ @BlockWord ë°©ì‹**: Jackson ContextualSerializerë¥¼ í™œìš©í•˜ì—¬ ì§ë ¬í™” ì‹œì ì—ì„œ ì°¨ë‹¨ëœ ì‚¬ìš©ì ì»¨í…ì¸ ë¥¼ ìë™ìœ¼ë¡œ ëŒ€ì²´í•˜ëŠ” êµ¬í˜„

## ğŸ¯ êµ¬í˜„ êµ¬ì„±ìš”ì†Œ

### 1. @BlockWord ì–´ë…¸í…Œì´ì…˜
```java
@Target(ElementType.FIELD)
@Retention(RetentionPolicy.RUNTIME)
public @interface BlockWord {
    String value() default "ì°¨ë‹¨ëœ ì‚¬ìš©ìì˜ ê¸€ì…ë‹ˆë‹¤";
    String userIdPath() default "userId";
}
```

### 2. BlockWordSerializer
```java
@Component
public class BlockWordSerializer extends JsonSerializer<String> implements ContextualSerializer {
    
    @Override
    public void serialize(String value, JsonGenerator gen, SerializerProvider serializers) {
        // 1. í˜„ì¬ ì‚¬ìš©ì ID íšë“ (SecurityContextUtil)
        // 2. ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ìëŠ” í•„í„°ë§ ìŠ¤í‚µ
        // 3. userIdPathë¡œ ì‘ì„±ì ID ì¶”ì¶œ (ë¦¬í”Œë ‰ì…˜)
        // 4. BlockService.isBlocked() í˜¸ì¶œ
        // 5. ì°¨ë‹¨ëœ ê²½ìš° ëŒ€ì²´ ë©”ì‹œì§€ë¡œ ë³€ê²½
    }
    
    @Override
    public JsonSerializer<?> createContextual(SerializerProvider prov, BeanProperty property) {
        // @BlockWord ì–´ë…¸í…Œì´ì…˜ ê°ì§€í•˜ì—¬ ì»¨í…ìŠ¤íŠ¸ë³„ ì‹œë¦¬ì–¼ë¼ì´ì € ìƒì„±
    }
}
```

### 3. BlockWordConfig
```java
@Configuration
public class BlockWordConfig {
    
    @PostConstruct
    public void configureObjectMapper() {
        SimpleModule blockWordModule = new SimpleModule("BlockWordModule");
        blockWordModule.addSerializer(String.class, blockWordSerializer);
        objectMapper.registerModule(blockWordModule);
    }
}
```

## ğŸ”§ ë™ì‘ ê³¼ì •

### 1. ì‹œë¦¬ì–¼ë¼ì´ì € ë“±ë¡
- ObjectMapperì— BlockWordSerializerë¥¼ String íƒ€ì…ì— ëŒ€í•´ ë“±ë¡
- @BlockWord ì–´ë…¸í…Œì´ì…˜ì´ ìˆëŠ” í•„ë“œì—ì„œë§Œ ë™ì‘í•˜ë„ë¡ ContextualSerializer í™œìš©

### 2. ì§ë ¬í™” ì‹œì  ì²˜ë¦¬
```java
// JSON ì§ë ¬í™” ì‹œì ì—ì„œ ìë™ í˜¸ì¶œ
serialize(String value, JsonGenerator gen, SerializerProvider serializers) {
    
    // í˜„ì¬ ì‚¬ìš©ì ID íšë“
    Long currentUserId = SecurityContextUtil.getUserIdByContext().orElse(null);
    if (currentUserId == null) {
        gen.writeString(value);  // ë¹„ë¡œê·¸ì¸ â†’ ì›ë³¸ ë°˜í™˜
        return;
    }
    
    // ì‘ì„±ì ID ì¶”ì¶œ (ë¦¬í”Œë ‰ì…˜)
    Object currentObject = gen.getCurrentValue();
    Long authorId = extractUserIdByPath(currentObject, userIdPath);
    
    // ì°¨ë‹¨ ê´€ê³„ í™•ì¸
    boolean isBlocked = blockService.isBlocked(currentUserId, authorId);
    if (isBlocked) {
        gen.writeString(ëŒ€ì²´ë©”ì‹œì§€);  // ì°¨ë‹¨ë¨ â†’ ëŒ€ì²´ ë©”ì‹œì§€
    } else {
        gen.writeString(value);     // ì •ìƒ â†’ ì›ë³¸ ê°’
    }
}
```

### 3. ê²½ë¡œ ê¸°ë°˜ userId ì¶”ì¶œ
```java
private Long extractUserIdByPath(Object object, String userIdPath) {
    String[] pathParts = userIdPath.split("\\.");
    Object currentObject = object;
    
    // dot notation ê²½ë¡œ íƒìƒ‰
    for (String part : pathParts) {
        Field field = findField(currentObject.getClass(), part);
        field.setAccessible(true);
        currentObject = field.get(currentObject);
    }
    
    return (Long) currentObject;
}
```

## ğŸ“ ì‚¬ìš© ì˜ˆì‹œ

### ReviewInfo ì ìš©
```java
@Builder
public record ReviewInfo(
    Long reviewId,
    
    @BlockWord(userIdPath = "userInfo.userId")
    String reviewContent,
    
    UserInfo userInfo
) {}
```

### UserInfo ì ìš©
```java
public record UserInfo(
    Long userId,
    
    @BlockWord(value = "ì°¨ë‹¨ëœ ì‚¬ìš©ì", userIdPath = "userId")  
    String nickName,
    
    String userProfileImage
) {}
```

## ğŸ¨ ì²˜ë¦¬ ê²°ê³¼

### ì •ìƒ ì‚¬ìš©ì
```json
{
  "reviewContent": "ì •ë§ ë§›ìˆëŠ” ìœ„ìŠ¤í‚¤ì…ë‹ˆë‹¤!",
  "userInfo": {
    "userId": 123,
    "nickName": "ìœ„ìŠ¤í‚¤ëŸ¬ë²„"
  }
}
```

### ì°¨ë‹¨ëœ ì‚¬ìš©ì
```json
{
  "reviewContent": "ì°¨ë‹¨ëœ ì‚¬ìš©ìì˜ ê¸€ì…ë‹ˆë‹¤",
  "userInfo": {
    "userId": 456,
    "nickName": "ì°¨ë‹¨ëœ ì‚¬ìš©ì"
  }
}
```

## ğŸ› ï¸ êµ¬í˜„ íŠ¹ì§•

### 1. ContextualSerializer í™œìš©
- BeanPropertyì—ì„œ @BlockWord ì–´ë…¸í…Œì´ì…˜ ì¶”ì¶œ
- ì–´ë…¸í…Œì´ì…˜ë³„ë¡œ ë…ë¦½ì ì¸ ì‹œë¦¬ì–¼ë¼ì´ì € ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
- í•„ë“œë³„ ê°œë³„ ì„¤ì • ì ìš©

### 2. ë¦¬í”Œë ‰ì…˜ ê¸°ë°˜ ê²½ë¡œ íƒìƒ‰
- dot notation ì§€ì›: "userInfo.userId"
- í´ë˜ìŠ¤ ìƒì† ê³„ì¸µ ê³ ë ¤í•œ í•„ë“œ ê²€ìƒ‰
- ì‹¤íŒ¨ ì‹œ ì›ë³¸ ê°’ ë°˜í™˜ìœ¼ë¡œ ì•ˆì •ì„± í™•ë³´

### 3. í˜„ì¬ ì‚¬ìš©ì ì»¨í…ìŠ¤íŠ¸
- SecurityContextUtil.getUserIdByContext() í™œìš©
- Optional ë°˜í™˜ê°’ ì²˜ë¦¬ë¡œ ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì ê³ ë ¤
- ì˜ˆì™¸ ìƒí™©ì—ì„œ ì›ë³¸ ê°’ ë³´ì¡´

### 4. ì—ëŸ¬ í•¸ë“¤ë§
- ê° ë‹¨ê³„ë³„ try-catchë¡œ ì•ˆì •ì„± í™•ë³´
- ì‹¤íŒ¨ ì‹œ ë¡œê·¸ ê¸°ë¡ í›„ ì›ë³¸ ê°’ ë°˜í™˜
- ìš´ì˜ ì¤‘ ì¥ì•  ë°©ì§€ë¥¼ ìœ„í•œ ë°©ì–´ì  í”„ë¡œê·¸ë˜ë°

## ğŸ“‹ êµ¬í˜„ íŒŒì¼ êµ¬ì¡°

```
common/block/
â”œâ”€â”€ annotation/
â”‚   â””â”€â”€ BlockWord.java           # ì–´ë…¸í…Œì´ì…˜ ì •ì˜
â”œâ”€â”€ serializer/
â”‚   â””â”€â”€ BlockWordSerializer.java # Jackson ì»¤ìŠ¤í…€ ì‹œë¦¬ì–¼ë¼ì´ì €
â”œâ”€â”€ config/
â”‚   â””â”€â”€ BlockWordConfig.java     # ObjectMapper ì„¤ì •
â””â”€â”€ service/
    â””â”€â”€ BlockService.java        # ì°¨ë‹¨ ê´€ê³„ ì¡°íšŒ (ê¸°ì¡´)
```

## ğŸ“ ê²°ë¡ 

Jacksonì˜ ContextualSerializerë¥¼ í™œìš©í•œ ë°©ì‹ìœ¼ë¡œ í•„ë“œ ë ˆë²¨ì—ì„œ ì„¸ë°€í•œ ë¸”ë¡ í•„í„°ë§ì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤. AOP ë°©ì‹ì˜ ë³µì¡ì„±ì„ ì œê±°í•˜ê³  ì§ë ¬í™” ì‹œì ì—ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ì²˜ë¦¬ë˜ë„ë¡ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.