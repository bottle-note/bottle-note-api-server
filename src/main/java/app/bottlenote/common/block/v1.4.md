# 블록 필터링 v1.4 - 최종 단순화된 @BlockWord 방식

## 📋 개요

**@BlockWord 어노테이션**: JSON 직렬화 시점에서 차단된 사용자 컨텐츠를 대체 메시지로 자동 변경

## 🎯 @BlockWord 어노테이션

```java
@Target(ElementType.FIELD)
@Retention(RetentionPolicy.RUNTIME)
public @interface BlockWord {
    /**
     * 차단된 사용자 컨텐츠 대체 메시지
     * 기본값: "차단된 사용자의 글입니다"
     */
    String value() default "차단된 사용자의 글입니다";
    
    /**
     * 차단 판단 기준이 되는 사용자 ID 경로
     * 기본값: "userId"
     * 중첩 객체: "userInfo.userId" 형태 지원
     */
    String userIdPath() default "userId";
}
```

## 📝 사용 예시

### ReviewInfo
```java
@Builder
public record ReviewInfo(
    Long reviewId,
    
    @BlockWord(userIdPath = "userInfo.userId")
    String reviewContent,
    
    UserInfo userInfo,
    // ... 기타 필드들
) {}
```

### UserInfo
```java
public record UserInfo(
    Long userId,
    
    @BlockWord(value = "차단된 사용자", userIdPath = "userId")
    String nickName,
    
    String userProfileImage
) {}
```

## 🔧 동작 흐름

### 1. 현재 사용자 ID 획득
```java
// SecurityContextUtils 활용
Long currentUserId = SecurityContextUtil.getUserIdByContext().orElse(null);

// 비로그인 사용자 처리
if (currentUserId == null) {
    // 필터링 스킵, 원본 값 그대로 반환
    return originalValue;
}
```

### 2. 작성자 userId 추출
```java
// userIdPath로 리플렉션을 통해 userId 추출
// "userId" → 같은 객체 내 userId 필드
// "userInfo.userId" → userInfo 객체 내부의 userId 필드
Long authorId = extractUserIdByPath(object, userIdPath);
```

### 3. 차단 관계 확인 및 처리
```java
// BlockService를 통한 차단 관계 확인 (캐시 제외)
boolean isBlocked = blockService.isBlocked(currentUserId, authorId);

if (isBlocked) {
    return 대체메시지;  // "@BlockWord" 어노테이션의 value 값
} else {
    return 원본값;
}
```

## 🎨 처리 결과

### 정상 사용자
```json
{
  "reviewContent": "정말 맛있는 위스키입니다!",
  "userInfo": {
    "userId": 123,
    "nickName": "위스키러버"
  }
}
```

### 차단된 사용자
```json
{
  "reviewContent": "차단된 사용자의 글입니다",
  "userInfo": {
    "userId": 456,
    "nickName": "차단된 사용자"
  }
}
```

### 비로그인 사용자
```json
{
  "reviewContent": "정말 맛있는 위스키입니다!",
  "userInfo": {
    "userId": 123,
    "nickName": "위스키러버"
  }
}
```

## 🛠️ 구현 핵심 요소

### 1. Jackson 커스텀 시리얼라이저
- `@BlockWord` 어노테이션 감지
- 필드별 조건부 값 변경
- 직렬화 시점에서만 처리

### 2. 경로 기반 userId 추출
- dot notation 파싱: `"userInfo.userId"`
- 리플렉션을 통한 중첩 객체 접근
- 경로 오류 시 예외 처리

### 3. 사용자 컨텍스트 처리
- `SecurityContextUtil.getUserIdByContext()` 활용
- `Optional<Long>` 반환값 처리
- 비로그인 사용자는 필터링 스킵

### 4. 단순한 블록 검사
- `BlockService.isBlocked(currentUserId, authorId)` 호출
- 캐싱 메커니즘 제외
- 차단된 경우에만 대체 메시지 적용

## 📋 처리 조건

| 상황 | 동작 |
|------|------|
| 비로그인 사용자 | 원본 값 그대로 반환 (필터링 안 함) |
| 로그인 + 차단 안 됨 | 원본 값 그대로 반환 |
| 로그인 + 차단됨 | 대체 메시지로 변경 |
| userIdPath 오류 | 원본 값 그대로 반환 + 로그 기록 |