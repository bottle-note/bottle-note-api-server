# 어드민 배너 CRUD 기능 구현 계획

## 개요

어드민 API에 배너 관리(CRUD) 기능을 추가한다.
기존 큐레이션(Curation) Admin 패턴을 그대로 따르며, product-api의 배너 조회 전용 구조를 admin용으로 확장한다.

## 현재 상태

- **Banner 엔티티**: 구현 완료 (`Banner.java`, 16개 필드)
- **Product API**: 조회 전용 (`GET /api/v1/banners`) - `BannerQueryService`, `BannerQueryController`
- **BannerRepository**: `findById`, `findAllByIsActiveTrue` 2개 메서드만 존재 (조회 전용)
- **Admin API**: 배너 관련 코드 없음
- **Banner 엔티티 update 메서드**: 없음 (현재 Builder만 존재)

## 엔드포인트 설계

context-path: `/admin/api/v1`

| HTTP | URL | 설명 | 요청 |
|------|-----|------|------|
| GET | `/banners` | 배너 목록 조회 (페이징, 필터) | `@ModelAttribute AdminBannerSearchRequest` |
| GET | `/banners/{bannerId}` | 배너 단건 상세 조회 | `@PathVariable` |
| POST | `/banners` | 배너 생성 | `@RequestBody @Valid AdminBannerCreateRequest` |
| PUT | `/banners/{bannerId}` | 배너 수정 | `@RequestBody @Valid AdminBannerUpdateRequest` |
| DELETE | `/banners/{bannerId}` | 배너 삭제 | `@PathVariable` |
| PATCH | `/banners/{bannerId}/status` | 활성화 상태 변경 | `@RequestBody AdminBannerStatusRequest` |
| PATCH | `/banners/{bannerId}/sort-order` | 정렬 순서 변경 | `@RequestBody AdminBannerSortOrderRequest` |

## 구현 파일 목록

### Phase 1: mono 모듈 - 도메인/리포지토리 확장

#### 1-1. Banner 엔티티 수정 메서드 추가
- **파일**: `bottlenote-mono/src/main/java/app/bottlenote/banner/domain/Banner.java`
- **작업**: `update()`, `updateStatus()`, `updateSortOrder()` 메서드 추가

```java
public void update(String name, String nameFontColor, String descriptionA, String descriptionB,
    String descriptionFontColor, String imageUrl, TextPosition textPosition,
    Boolean isExternalUrl, String targetUrl, BannerType bannerType,
    Integer sortOrder, LocalDateTime startDate, LocalDateTime endDate, Boolean isActive) {
    this.name = name;
    this.nameFontColor = nameFontColor;
    this.descriptionA = descriptionA;
    this.descriptionB = descriptionB;
    this.descriptionFontColor = descriptionFontColor;
    this.imageUrl = imageUrl;
    this.textPosition = textPosition;
    this.isExternalUrl = isExternalUrl;
    this.targetUrl = targetUrl;
    this.bannerType = bannerType;
    this.sortOrder = sortOrder;
    this.startDate = startDate;
    this.endDate = endDate;
    this.isActive = isActive;
}

public void updateStatus(Boolean isActive) {
    this.isActive = isActive;
}

public void updateSortOrder(Integer sortOrder) {
    this.sortOrder = sortOrder;
}
```

#### 1-2. BannerRepository에 Admin용 메서드 추가
- **파일**: `bottlenote-mono/src/main/java/app/bottlenote/banner/domain/BannerRepository.java`
- **작업**: `save`, `delete`, `existsByName` 메서드 추가

```java
Banner save(Banner banner);
void delete(Banner banner);
boolean existsByName(String name);
Page<AdminBannerListResponse> searchForAdmin(AdminBannerSearchRequest request, Pageable pageable);
```

#### 1-3. JpaBannerRepository에 메서드 추가
- **파일**: `bottlenote-mono/src/main/java/app/bottlenote/banner/repository/JpaBannerRepository.java`
- **작업**: `JpaRepository<Banner, Long>`이 이미 상속하므로 `save`, `delete`는 자동 제공. `existsByName` 추가.

#### 1-4. CustomBannerRepository + Impl 생성 (QueryDSL)
- **신규 파일**: `bottlenote-mono/src/main/java/app/bottlenote/banner/repository/CustomBannerRepository.java`
- **신규 파일**: `bottlenote-mono/src/main/java/app/bottlenote/banner/repository/CustomBannerRepositoryImpl.java`
- **작업**: `searchForAdmin` QueryDSL 구현 (키워드 검색, isActive 필터, bannerType 필터, 페이징)

```java
// CustomBannerRepository.java
public interface CustomBannerRepository {
    Page<AdminBannerListResponse> searchForAdmin(AdminBannerSearchRequest request, Pageable pageable);
}

// CustomBannerRepositoryImpl.java - QueryDSL 구현
// 검색 조건: keyword(name LIKE), isActive, bannerType
// 정렬: sortOrder ASC, id DESC
// 페이징: offset 기반
```

### Phase 2: mono 모듈 - DTO

#### 2-1. 요청 DTO (record)
- **신규 파일**: `bottlenote-mono/src/main/java/app/bottlenote/banner/dto/request/AdminBannerSearchRequest.java`

```java
public record AdminBannerSearchRequest(
    String keyword,          // 배너명 검색
    Boolean isActive,        // 활성화 상태 필터 (null: 전체)
    BannerType bannerType,   // 배너 유형 필터 (null: 전체)
    Integer page,            // 기본값 0
    Integer size             // 기본값 20
) {}
```

- **신규 파일**: `bottlenote-mono/src/main/java/app/bottlenote/banner/dto/request/AdminBannerCreateRequest.java`

```java
public record AdminBannerCreateRequest(
    @NotBlank String name,
    String nameFontColor,         // 기본값 "#ffffff"
    @Size(max = 50) String descriptionA,
    @Size(max = 50) String descriptionB,
    String descriptionFontColor,  // 기본값 "#ffffff"
    @NotBlank String imageUrl,
    TextPosition textPosition,    // 기본값 RT
    Boolean isExternalUrl,        // 기본값 false
    String targetUrl,
    @NotNull BannerType bannerType,
    Integer sortOrder,            // 기본값 0
    LocalDateTime startDate,
    LocalDateTime endDate
) {}
```

- **신규 파일**: `bottlenote-mono/src/main/java/app/bottlenote/banner/dto/request/AdminBannerUpdateRequest.java`

```java
public record AdminBannerUpdateRequest(
    @NotBlank String name,
    String nameFontColor,
    @Size(max = 50) String descriptionA,
    @Size(max = 50) String descriptionB,
    String descriptionFontColor,
    @NotBlank String imageUrl,
    TextPosition textPosition,
    Boolean isExternalUrl,
    String targetUrl,
    @NotNull BannerType bannerType,
    @NotNull Integer sortOrder,
    LocalDateTime startDate,
    LocalDateTime endDate,
    @NotNull Boolean isActive
) {}
```

- **신규 파일**: `bottlenote-mono/src/main/java/app/bottlenote/banner/dto/request/AdminBannerStatusRequest.java`

```java
public record AdminBannerStatusRequest(
    @NotNull Boolean isActive
) {}
```

- **신규 파일**: `bottlenote-mono/src/main/java/app/bottlenote/banner/dto/request/AdminBannerSortOrderRequest.java`

```java
public record AdminBannerSortOrderRequest(
    @NotNull @Min(0) Integer sortOrder
) {}
```

#### 2-2. 응답 DTO (record)
- **신규 파일**: `bottlenote-mono/src/main/java/app/bottlenote/banner/dto/response/AdminBannerListResponse.java`

```java
public record AdminBannerListResponse(
    Long id,
    String name,
    BannerType bannerType,
    Integer sortOrder,
    Boolean isActive,
    LocalDateTime startDate,
    LocalDateTime endDate,
    LocalDateTime createdAt
) {}
```

- **신규 파일**: `bottlenote-mono/src/main/java/app/bottlenote/banner/dto/response/AdminBannerDetailResponse.java`

```java
public record AdminBannerDetailResponse(
    Long id,
    String name,
    String nameFontColor,
    String descriptionA,
    String descriptionB,
    String descriptionFontColor,
    String imageUrl,
    TextPosition textPosition,
    Boolean isExternalUrl,
    String targetUrl,
    BannerType bannerType,
    Integer sortOrder,
    LocalDateTime startDate,
    LocalDateTime endDate,
    Boolean isActive,
    LocalDateTime createdAt,
    LocalDateTime modifiedAt
) {
    public static AdminBannerDetailResponse of(Banner banner) { ... }
}
```

### Phase 3: mono 모듈 - 서비스 + 예외

#### 3-1. AdminBannerService 생성
- **신규 파일**: `bottlenote-mono/src/main/java/app/bottlenote/banner/service/AdminBannerService.java`

```java
@Service
@RequiredArgsConstructor
public class AdminBannerService {

    private final BannerRepository bannerRepository;

    // 목록 조회 (페이징)
    @Transactional(readOnly = true)
    public GlobalResponse search(AdminBannerSearchRequest request) { ... }

    // 단건 상세 조회
    @Transactional(readOnly = true)
    public AdminBannerDetailResponse getDetail(Long bannerId) { ... }

    // 생성
    @Transactional
    public AdminResultResponse create(AdminBannerCreateRequest request) { ... }

    // 수정
    @Transactional
    public AdminResultResponse update(Long bannerId, AdminBannerUpdateRequest request) { ... }

    // 삭제
    @Transactional
    public AdminResultResponse delete(Long bannerId) { ... }

    // 활성화 상태 변경
    @Transactional
    public AdminResultResponse updateStatus(Long bannerId, AdminBannerStatusRequest request) { ... }

    // 정렬 순서 변경
    @Transactional
    public AdminResultResponse updateSortOrder(Long bannerId, AdminBannerSortOrderRequest request) { ... }
}
```

#### 3-2. BannerExceptionCode 생성
- **신규 파일**: `bottlenote-mono/src/main/java/app/bottlenote/banner/exception/BannerExceptionCode.java`

```java
public enum BannerExceptionCode implements ExceptionCode {
    BANNER_NOT_FOUND(HttpStatus.NOT_FOUND, "배너를 찾을 수 없습니다."),
    BANNER_DUPLICATE_NAME(HttpStatus.CONFLICT, "동일한 이름의 배너가 이미 존재합니다.");
}
```

- **신규 파일**: `bottlenote-mono/src/main/java/app/bottlenote/banner/exception/BannerException.java`

```java
public class BannerException extends CustomException {
    public BannerException(BannerExceptionCode code) { super(code); }
}
```

#### 3-3. AdminResultResponse.ResultCode에 배너 코드 추가
- **파일**: `bottlenote-mono/src/main/java/app/bottlenote/global/dto/response/AdminResultResponse.java`
- **작업**: ResultCode enum에 추가

```java
BANNER_CREATED("배너가 등록되었습니다."),
BANNER_UPDATED("배너가 수정되었습니다."),
BANNER_DELETED("배너가 삭제되었습니다."),
BANNER_STATUS_UPDATED("배너 활성화 상태가 변경되었습니다."),
BANNER_SORT_ORDER_UPDATED("배너 정렬 순서가 변경되었습니다."),
```

### Phase 4: admin-api 모듈 - 컨트롤러

#### 4-1. AdminBannerController 생성
- **신규 파일**: `bottlenote-admin-api/src/main/kotlin/app/bottlenote/banner/presentation/AdminBannerController.kt`

```kotlin
@RestController
@RequestMapping("/banners")
class AdminBannerController(
    private val adminBannerService: AdminBannerService
) {
    @GetMapping
    fun list(@ModelAttribute request: AdminBannerSearchRequest): ResponseEntity<GlobalResponse> { ... }

    @GetMapping("/{bannerId}")
    fun detail(@PathVariable bannerId: Long): ResponseEntity<*> { ... }

    @PostMapping
    fun create(@RequestBody @Valid request: AdminBannerCreateRequest): ResponseEntity<*> { ... }

    @PutMapping("/{bannerId}")
    fun update(@PathVariable bannerId: Long, @RequestBody @Valid request: AdminBannerUpdateRequest): ResponseEntity<*> { ... }

    @DeleteMapping("/{bannerId}")
    fun delete(@PathVariable bannerId: Long): ResponseEntity<*> { ... }

    @PatchMapping("/{bannerId}/status")
    fun updateStatus(@PathVariable bannerId: Long, @RequestBody @Valid request: AdminBannerStatusRequest): ResponseEntity<*> { ... }

    @PatchMapping("/{bannerId}/sort-order")
    fun updateSortOrder(@PathVariable bannerId: Long, @RequestBody @Valid request: AdminBannerSortOrderRequest): ResponseEntity<*> { ... }
}
```

### Phase 5: 테스트

#### 5-1. 테스트 헬퍼
- **신규 파일**: `bottlenote-admin-api/src/test/kotlin/app/helper/banner/BannerHelper.kt`
- **역할**: 테스트용 요청/응답 데이터 생성 (`object` 싱글톤)

#### 5-2. 통합 테스트
- **신규 파일**: `bottlenote-admin-api/src/test/kotlin/app/integration/banner/AdminBannerIntegrationTest.kt`
- **태그**: `@Tag("admin_integration")`
- **베이스**: `IntegrationTestSupport` 상속
- **시나리오**:
  - 목록 조회 (기본, 키워드 필터, 활성화 필터, bannerType 필터)
  - 상세 조회 (성공, 404)
  - 생성 (성공, 필수값 누락 검증)
  - 수정 (성공, 404)
  - 삭제 (성공, 404)
  - 상태 변경 (성공)
  - 정렬 순서 변경 (성공)
  - 인증 실패 테스트

#### 5-3. RestDocs 테스트
- **신규 파일**: `bottlenote-admin-api/src/test/kotlin/app/docs/banner/AdminBannerControllerDocsTest.kt`
- **설정**: `@WebMvcTest`, `@AutoConfigureRestDocs`, `@MockitoBean`
- **문서화**: 각 API별 요청/응답 필드 문서화

## 파일 변경 요약

### 수정 파일 (4개)
| 파일 | 작업 |
|------|------|
| `Banner.java` | update, updateStatus, updateSortOrder 메서드 추가 |
| `BannerRepository.java` | save, delete, existsByName, searchForAdmin 메서드 추가 |
| `JpaBannerRepository.java` | CustomBannerRepository 상속 추가, existsByName 추가 |
| `AdminResultResponse.java` | ResultCode에 BANNER_* 5개 코드 추가 |

### 신규 파일 (15개)

**mono 모듈 (12개)**:
| 파일 | 위치 |
|------|------|
| `CustomBannerRepository.java` | banner/repository/ |
| `CustomBannerRepositoryImpl.java` | banner/repository/ |
| `AdminBannerSearchRequest.java` | banner/dto/request/ |
| `AdminBannerCreateRequest.java` | banner/dto/request/ |
| `AdminBannerUpdateRequest.java` | banner/dto/request/ |
| `AdminBannerStatusRequest.java` | banner/dto/request/ |
| `AdminBannerSortOrderRequest.java` | banner/dto/request/ |
| `AdminBannerListResponse.java` | banner/dto/response/ |
| `AdminBannerDetailResponse.java` | banner/dto/response/ |
| `AdminBannerService.java` | banner/service/ |
| `BannerExceptionCode.java` | banner/exception/ |
| `BannerException.java` | banner/exception/ |

**admin-api 모듈 (3개)**:
| 파일 | 위치 |
|------|------|
| `AdminBannerController.kt` | banner/presentation/ |
| `AdminBannerIntegrationTest.kt` | integration/banner/ |
| `AdminBannerControllerDocsTest.kt` | docs/banner/ |

**admin-api 테스트 헬퍼 (1개)**:
| 파일 | 위치 |
|------|------|
| `BannerHelper.kt` | helper/banner/ |

## 구현 순서

```
Phase 1 (도메인/리포지토리) → Phase 2 (DTO) → Phase 3 (서비스/예외) → Phase 4 (컨트롤러) → Phase 5 (테스트)
```

각 Phase 완료 후 컴파일 확인:
- Phase 1-3: `./gradlew :bottlenote-mono:compileJava`
- Phase 4: `./gradlew :bottlenote-admin-api:compileKotlin`
- Phase 5: `./gradlew :bottlenote-admin-api:admin_integration_test`

## 참고 패턴

- 큐레이션 Admin CRUD (`AdminCurationController.kt` + `AdminCurationService.java`) 패턴과 동일한 구조
- 응답 래핑: `GlobalResponse.ok()`, `GlobalResponse.fromPage()`
- 결과 응답: `AdminResultResponse.of(ResultCode, targetId)`
- 예외 처리: 도메인 전용 Exception + ExceptionCode enum
