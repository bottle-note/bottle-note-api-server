# actë¡œ ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš© workflow
# ì‹¤í–‰: act workflow_dispatch -W .github/workflows/act/test-image-update.yml --secret-file .secrets --container-architecture linux/arm64

name: Test Image Tag Update

on:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Git commit SHA (í…ŒìŠ¤íŠ¸ìš©)'
        required: false
        default: 'abc1234'

jobs:
  update-image-tag:
    runs-on: ubuntu-latest
    steps:
      - name: checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.GIT_ACCESS_TOKEN }}

      # Kustomize ì„¤ì¹˜ (GitHub Marketplaceì˜ ê²€ì¦ëœ ì•¡ì…˜ ì‚¬ìš©)
      # 2,475ê°œ ì €ì¥ì†Œì—ì„œ ì‚¬ìš© ì¤‘ì¸ ì•ˆì •ì ì¸ ì•¡ì…˜
      # GitHub Actionsì—ì„œëŠ” GITHUB_TOKENì´ ìë™ ì œê³µë¨
      - name: setup kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          # kustomize-version: '5.0.0'  # íŠ¹ì • ë²„ì „ í•„ìš” ì‹œ ì£¼ì„ í•´ì œ

      - name: update image tag with kustomize
        run: |
          COMMIT_SHA="${{ github.event.inputs.commit_sha || github.sha }}"
          IMAGE_TAG="development_${COMMIT_SHA:0:7}"

          echo "ğŸ“¦ ì—…ë°ì´íŠ¸í•  ì´ë¯¸ì§€ íƒœê·¸: $IMAGE_TAG"

          cd git.environment-variables/deploy/overlays/development

          # í˜„ì¬ kustomization.yaml ë‚´ìš© í™•ì¸
          echo "========== ë³€ê²½ ì „ =========="
          cat kustomization.yaml

          # Kustomizeë¡œ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
          kustomize edit set image \
            536697247604.dkr.ecr.ap-northeast-2.amazonaws.com/ecr-bottle-note-api=536697247604.dkr.ecr.ap-northeast-2.amazonaws.com/ecr-bottle-note-api:${IMAGE_TAG}

          # ë³€ê²½ í›„ ë‚´ìš© í™•ì¸
          echo "========== ë³€ê²½ í›„ =========="
          cat kustomization.yaml

          # Git diff í™•ì¸
          echo "========== Git Diff =========="
          git diff kustomization.yaml

      - name: commit and push (with branch checkout)
        run: |
          cd git.environment-variables

          echo "========== Git Status (ë³€ê²½ ì „) =========="
          git status

          # detached HEAD í•´ê²°: main ë¸Œëœì¹˜ë¡œ ì „í™˜
          echo "========== Checkout main branch =========="
          git checkout main

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add deploy/overlays/development/kustomization.yaml

          echo "========== Commit (DRY RUN - ì‹¤ì œë¡œëŠ” ì»¤ë°‹í•˜ì§€ ì•ŠìŒ) =========="
          git diff --cached

          echo "âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
          echo "ì‹¤ì œ workflowì—ì„œëŠ” ì—¬ê¸°ì„œ commit & push ì‹¤í–‰ë¨"
