# act 로컬 테스트용 워크플로우 (Admin API)
#  act workflow_dispatch -W .github/workflows/act/zot-image-upload-test.yaml.yml --secret-file .secrets
name: Zot Admin API Image Upload Test

on:
  workflow_dispatch:

jobs:
  build-and-push-to-zot:
    runs-on: ubuntu-24.04-arm
    env:
      GITHUB_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GIT_ACCESS_TOKEN }}

      - name: Checkout submodules
        run: |
          git config --global url."https://${{ secrets.GIT_ACCESS_TOKEN }}@github.com/".insteadOf "https://github.com/"
          git submodule update --init git.environment-variables

      - name: Read admin version
        id: version
        run: |
          VERSION=$(cat bottlenote-admin-api/VERSION | tr -d '[:space:]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Admin version: $VERSION"

      - name: Build and Push to Zot Registry
        uses: ./.github/actions/docker-build-push
        with:
          registry-url: ${{ secrets.REGISTRY_ADDRESS }}
          registry-username: ${{ secrets.REGISTRY_USERNAME }}
          registry-password: ${{ secrets.REGISTRY_PASSWORD }}
          image-name: bottlenote-admin-api
          image-tag: admin_${{ steps.version.outputs.version }}
          additional-tags: admin_latest
          dockerfile: Dockerfile-admin
          cache-scope: admin
          platforms: linux/arm64
          image-title: "BottleNote Admin API"
          image-description: "BottleNote Admin API Server"
          image-vendor: "BottleNote"
          image-authors: "BottleNote Team"
          sign-image: 'true'
          cosign-key-path: 'git.environment-variables/storage/docker-registry/cosign.key'
          cosign-password: ${{ secrets.COSIGN_PASSWORD }}

      - name: Verify push result
        run: |
          echo "Image pushed successfully!"
          echo "Image: bottlenote-admin-api:admin_${{ steps.version.outputs.version }}"
          echo "Check your Zot registry"
