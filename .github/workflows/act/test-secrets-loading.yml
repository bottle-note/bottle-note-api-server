# export DOCKER_HOST="unix:///var/folders/x4/rbwfkbt52mg_xvm4gwvmjrpc0000gn/T/podman/podman-machine-default-api.sock"
# act workflow_dispatch -W .github/workflows/test-secrets-loading.yml --secret-file .secrets
name: Test Secrets Loading

on:
  workflow_dispatch:

jobs:
  test-load-secrets:
    runs-on: ubuntu-latest
    steps:
      # 1. λ ν¬μ§€ν† λ¦¬ μ²΄ν¬μ•„μ›ƒ (μ„λΈλ¨λ“ ν¬ν•¨)
      - name: λ ν¬μ§€ν† λ¦¬ μ²΄ν¬μ•„μ›ƒ (μ„λΈλ¨λ“ ν¬ν•¨)
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.GIT_ACCESS_TOKEN }}

      # 2. Oracle μΈμ¤ν„΄μ¤ ν™κ²½λ³€μ λ΅λ“
      - name: Oracle μΈμ¤ν„΄μ¤ ν™κ²½λ³€μ λ΅λ“
        env:
          ENV_FILE: git.environment-variables/deploy/oracle/application-node-1.env
        run: |
          echo "π“„ ν™κ²½λ³€μ νμΌ λ΅λ“ μ¤‘..."
          if [ ! -f "$ENV_FILE" ]; then
            echo "β ν™κ²½λ³€μ νμΌμ„ μ°Ύμ„ μ μ—†μµλ‹λ‹¤: $ENV_FILE"
            exit 1
          fi

          # .env νμΌ μ½μ–΄μ„ ν™κ²½λ³€μλ΅ μ„¤μ •
          while IFS='=' read -r key value || [ -n "$key" ]; do
            # λΉ μ¤„μ΄λ‚ μ£Όμ„ μ¤ν‚µ
            [[ -z "$key" || "$key" == \#* ]] && continue

            # λ¨λ“  κ°’ λ§μ¤ν‚Ή (ν‚¤λ§ λ…Έμ¶)
            echo "::add-mask::${value}"

            # GitHub ν™κ²½λ³€μλ΅ μ„¤μ •
            echo "${key}=${value}" >> $GITHUB_ENV
            echo "  β… $key λ΅λ“λ¨"
          done < "$ENV_FILE"

          echo ""
          echo "β… ν™κ²½λ³€μ λ΅λ“ μ™„λ£"


      # 3. SSH κ°μΈν‚¤ νμΌ λ΅λ“
      - name: SSH κ°μΈν‚¤ νμΌ λ΅λ“
        env:
          KEY_FILE: git.environment-variables/deploy/oracle/keys/node-1.pem
        run: |
          echo "π”‘ SSH κ°μΈν‚¤ νμΌ λ΅λ“ μ¤‘..."

          if [ ! -f "$KEY_FILE" ]; then
            echo "β SSH ν‚¤ νμΌμ„ μ°Ύμ„ μ μ—†μµλ‹λ‹¤: $KEY_FILE"
            exit 1
          fi

          # SSH ν‚¤ μ „μ²΄ λ‚΄μ©μ„ ν™κ²½λ³€μλ΅ μ €μ¥
          SSH_KEY=$(cat "$KEY_FILE")

          # SSH ν‚¤μ κ° μ¤„ λ§μ¤ν‚Ή
          echo "$SSH_KEY" | while IFS= read -r line; do
            [ -n "$line" ] && echo "::add-mask::${line}"
          done

          # λ©€ν‹°λΌμΈ ν™κ²½λ³€μλ΅ μ„¤μ •
          {
            echo "SSH_PRIVATE_KEY<<EOF_SSH_KEY"
            cat "$KEY_FILE"
            echo "EOF_SSH_KEY"
          } >> $GITHUB_ENV

          echo "β… SSH κ°μΈν‚¤ λ΅λ“ μ™„λ£"


      # 4. SSH μ ‘μ† ν…μ¤νΈ
      - name: SSH μ ‘μ† ν…μ¤νΈ
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.INSTANCE_NETWORK_PUBLIC_IP }}
          username: ${{ env.INSTANCE_HOST_USERNAME }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          port: ${{ env.INSTANCE_NETWORK_PORT }}
          script: |
            echo "=== π“΅ Oracle μΈμ¤ν„΄μ¤ μ ‘μ† μ„±κ³µ ==="
            echo ""
            echo "π§ μ‹μ¤ν… μ •λ³΄:"
            uname -a
            echo ""
            echo "π“‹ OS λ¦΄λ¦¬μ¦ μ •λ³΄:"
            cat /etc/os-release
            echo ""
            echo "=== β… SSH μ ‘μ† κ²€μ¦ μ™„λ£ ==="
