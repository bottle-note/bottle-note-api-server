# act workflow_dispatch    -W .github/workflows/deploy_production.yml    -j pre-deploy-health-check    --secret-file .secrets    --container-architecture linux/arm64    --verbose > act-test.log 2>&1
name: Production Rolling Deployment

on:
  workflow_dispatch:
  pull_request:
    types: [ closed ]
    branches:
      - prod

concurrency:
  group: "production-deploy-${{ github.event.pull_request.number }}"
  cancel-in-progress: true

env:
  ECR_REPOSITORY: "ecr-bottle-note-api"
  HEALTH_CHECK_TIMEOUT: "30"
  DEPLOY_TIMEOUT: "300"

jobs:
  build-and-push-ecr:
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.build-image.outputs.image_tag }}
      ecr_registry: ${{ steps.login-ecr.outputs.registry }}
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ (ì„œë¸Œëª¨ë“ˆ í¬í•¨)
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.GIT_ACCESS_TOKEN }}

      - name: 1Password ì„œë¹„ìŠ¤ ê³„ì • ì„¤ì •
        uses: 1password/load-secrets-action/configure@v2
        with:
          service-account-token: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

      - name: AWS ìê²©ì¦ëª… ë¡œë“œ
        uses: 1password/load-secrets-action@v2
        id: op-load-aws-secret
        with:
          export-env: true
        env:
          AWS_ACCESS_KEY_ID: "op://vault/ecr iam authentication/access key id"
          AWS_SECRET_ACCESS_KEY: "op://vault/ecr iam authentication/secret access key"
          AWS_REGION: "op://vault/ecr iam authentication/region"

      - name: AWS ìê²©ì¦ëª… êµ¬ì„±
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ECR ë¡œê·¸ì¸
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Docker Buildx ì„¤ì • (ìºì‹œ ì§€ì›)
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: ARM64 ìµœì í™” ë¹Œë“œ ë° í‘¸ì‹œ (GitHub Actions ìºì‹œ)
        id: build-image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/arm64
          push: true
          tags: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
          cache-from: type=gha,scope=${{ github.ref_name }}
          cache-to: type=gha,scope=${{ github.ref_name }},mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: ì´ë¯¸ì§€ íƒœê·¸ ì¶œë ¥ ì„¤ì •
        run: |
          IMAGE_TAG="${GITHUB_SHA:0:7}"
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "::notice title=ECR ë¹Œë“œ ì™„ë£Œ::ì´ë¯¸ì§€ íƒœê·¸: $IMAGE_TAG"
          echo "::notice title=ë¹Œë“œ í”Œë«í¼::linux/arm64 (aarch64 ìµœì í™”)"


  # ë°°í¬ ì „ í”„ë¡œë•ì…˜ ì„œë²„ ìƒíƒœ í™•ì¸ (HTTP í—¬ìŠ¤ì²´í¬)
  pre-deploy-health-check:
    needs: build-and-push-ecr
    runs-on: ubuntu-latest
    outputs:
      overall_status: ${{ steps.final-status.outputs.status }}
      cluster1_status: ${{ steps.cluster1-check.outputs.status }}
      cluster2_status: ${{ steps.cluster2-check.outputs.status }}
    steps:
      - name: 1Password ì„œë¹„ìŠ¤ ê³„ì • ì„¤ì •
        uses: 1password/load-secrets-action/configure@v2
        with:
          service-account-token: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

      - name: í´ëŸ¬ìŠ¤í„° ì •ë³´ ë¡œë“œ
        uses: 1password/load-secrets-action@v2
        with:
          export-env: true
        env:
          # í´ëŸ¬ìŠ¤í„° 1 ì •ë³´
          CLUSTER1_IP: "op://vault/product-cluster-1/ip"
          CLUSTER1_PORT: "op://vault/product-cluster-1/port"
          # í´ëŸ¬ìŠ¤í„° 2 ì •ë³´
          CLUSTER2_IP: "op://vault/product-cluster-2/ip"
          CLUSTER2_PORT: "op://vault/product-cluster-2/port"

      - name: í´ëŸ¬ìŠ¤í„° 1 í—¬ìŠ¤ì²´í¬
        id: cluster1-check
        run: |
          echo "ğŸ” product-cluster-1 í—¬ìŠ¤ì²´í¬ ì‹œì‘..."

          # HTTP í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
          HEALTH_URL="http://$CLUSTER1_IP:30301/actuator/health"

          # ì„œë²„ ì‘ë‹µ í™•ì¸ (ìµœëŒ€ 30ì´ˆ ëŒ€ê¸°)
          if curl -f -s --max-time 30 --connect-timeout 10 "$HEALTH_URL" > /dev/null 2>&1; then
            echo "âœ… product-cluster-1 HTTP ì‘ë‹µ ì •ìƒ"

            # í—¬ìŠ¤ì²´í¬ ìƒì„¸ ì •ë³´ í™•ì¸
            HEALTH_RESPONSE=$(curl -s --max-time 10 "$HEALTH_URL" 2>/dev/null || echo '{"status":"UNKNOWN"}')
            echo "í—¬ìŠ¤ì²´í¬ ì‘ë‹µ: $HEALTH_RESPONSE"

            # JSONì—ì„œ status ì¶”ì¶œ
            STATUS=$(echo "$HEALTH_RESPONSE" | grep -o '"status":"[^"]*"' | cut -d'"' -f4 2>/dev/null || echo "UNKNOWN")

            if [ "$STATUS" = "UP" ]; then
              echo "âœ… product-cluster-1 ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ: UP"
              echo "status=healthy" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ product-cluster-1 ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ: $STATUS"
              echo "status=degraded" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ product-cluster-1 HTTP ì‘ë‹µ ì—†ìŒ ë˜ëŠ” ì˜¤ë¥˜"
            echo "- ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì¤‘ì§€ë˜ì—ˆê±°ë‚˜ ì²« ë°°í¬ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤"
            echo "status=down" >> $GITHUB_OUTPUT
          fi

      - name: í´ëŸ¬ìŠ¤í„° 2 í—¬ìŠ¤ì²´í¬
        id: cluster2-check
        run: |
          echo "ğŸ” product-cluster-2 í—¬ìŠ¤ì²´í¬ ì‹œì‘..."

          # HTTP í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
          HEALTH_URL="http://$CLUSTER2_IP:30301/actuator/health"

          # ì„œë²„ ì‘ë‹µ í™•ì¸ (ìµœëŒ€ 30ì´ˆ ëŒ€ê¸°)
          if curl -f -s --max-time 30 --connect-timeout 10 "$HEALTH_URL" > /dev/null 2>&1; then
            echo "âœ… product-cluster-2 HTTP ì‘ë‹µ ì •ìƒ"

            # í—¬ìŠ¤ì²´í¬ ìƒì„¸ ì •ë³´ í™•ì¸
            HEALTH_RESPONSE=$(curl -s --max-time 10 "$HEALTH_URL" 2>/dev/null || echo '{"status":"UNKNOWN"}')
            echo "í—¬ìŠ¤ì²´í¬ ì‘ë‹µ: $HEALTH_RESPONSE"

            # JSONì—ì„œ status ì¶”ì¶œ
            STATUS=$(echo "$HEALTH_RESPONSE" | grep -o '"status":"[^"]*"' | cut -d'"' -f4 2>/dev/null || echo "UNKNOWN")

            if [ "$STATUS" = "UP" ]; then
              echo "âœ… product-cluster-2 ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ: UP"
              echo "status=healthy" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ product-cluster-2 ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ: $STATUS"
              echo "status=degraded" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ product-cluster-2 HTTP ì‘ë‹µ ì—†ìŒ ë˜ëŠ” ì˜¤ë¥˜"
            echo "- ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì¤‘ì§€ë˜ì—ˆê±°ë‚˜ ì²« ë°°í¬ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤"
            echo "status=down" >> $GITHUB_OUTPUT
          fi

      - name: ì „ì²´ ìƒíƒœ íŒì •
        id: final-status
        run: |
          CLUSTER1_STATUS="${{ steps.cluster1-check.outputs.status }}"
          CLUSTER2_STATUS="${{ steps.cluster2-check.outputs.status }}"

          echo "ğŸ“Š í—¬ìŠ¤ì²´í¬ ìš”ì•½:"
          echo "- í´ëŸ¬ìŠ¤í„° 1: $CLUSTER1_STATUS"
          echo "- í´ëŸ¬ìŠ¤í„° 2: $CLUSTER2_STATUS"

          # ë°°í¬ ì§„í–‰ ì¡°ê±´: ì ì–´ë„ í•˜ë‚˜ëŠ” ì •ìƒì´ê±°ë‚˜, ëª¨ë‘ down(ì²« ë°°í¬)ì¸ ê²½ìš°
          if [ "$CLUSTER1_STATUS" = "healthy" ] || [ "$CLUSTER2_STATUS" = "healthy" ] ||
             ([ "$CLUSTER1_STATUS" = "down" ] && [ "$CLUSTER2_STATUS" = "down" ]); then
            echo "âœ… ì „ì²´ ìƒíƒœ: ë°°í¬ ì§„í–‰ ê°€ëŠ¥"
            echo "status=healthy" >> $GITHUB_OUTPUT
          else
            echo "âŒ ì „ì²´ ìƒíƒœ: ë°°í¬ ìœ„í—˜ - ì¤‘ë‹¨"
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: í—¬ìŠ¤ì²´í¬ ì™„ë£Œ ì•Œë¦¼
        if: always()
        run: |
          if [ "${{ steps.final-status.outputs.status }}" = "healthy" ]; then
            echo "::notice title=í—¬ìŠ¤ì²´í¬ ì™„ë£Œ::ë°°í¬ ì§„í–‰ ê°€ëŠ¥ ìƒíƒœì…ë‹ˆë‹¤. ë¡¤ë§ ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤."
          else
            echo "::error title=í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨::ë‘ í´ëŸ¬ìŠ¤í„° ëª¨ë‘ ë¬¸ì œê°€ ìˆì–´ ë°°í¬ê°€ ì¤‘ë‹¨ë©ë‹ˆë‹¤."
          fi

  # ë¡¤ë§ ë°°í¬ - ìˆœì°¨ì ìœ¼ë¡œ ê° í´ëŸ¬ìŠ¤í„°ì— ë°°í¬
  rolling-deploy:
    needs: [ build-and-push-ecr, pre-deploy-health-check ]
    if: needs.pre-deploy-health-check.outputs.overall_status == 'healthy'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        cluster: [ 'product-cluster-1', 'product-cluster-2' ]
      max-parallel: 1  # ìˆœì°¨ ë°°í¬ (ì²« ë²ˆì§¸ ì„±ê³µ í›„ ë‘ ë²ˆì§¸ ì‹¤í–‰)
      fail-fast: true  # í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ ì „ì²´ ì¤‘ë‹¨
    outputs:
      deployment_status: ${{ steps.deploy.outputs.status }}
      previous_image: ${{ steps.backup-info.outputs.previous_image }}
    steps:
      - name: 1Password ì¸ì¦ ì„¤ì •
        run: echo "Configure 1Password for ${{ matrix.cluster }}"

      - name: ${{ matrix.cluster }} SSH ìê²©ì¦ëª… ë¡œë“œ
        run: echo "Load SSH credentials for ${{ matrix.cluster }}"

      - name: ${{ matrix.cluster }} ë°°í¬ ì‹œì‘ ì•Œë¦¼
        run: echo "Starting deployment to ${{ matrix.cluster }}"

      - name: ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë³´ ë°±ì—… (ë¡¤ë°±ìš©)
        run: echo "Backup current container info for rollback"

      - name: ${{ matrix.cluster }}ì— SSH ì—°ê²° ë° ë°°í¬
        run: |
          echo "SSH to ${{ matrix.cluster }}"
          echo "- AWS ECR ë¡œê·¸ì¸"
          echo "- ìƒˆ ì´ë¯¸ì§€ Pull: ${{ needs.build-and-push-ecr.outputs.image_tag }}"
          echo "- ê¸°ì¡´ ì»¨í…Œì´ë„ˆ Graceful Shutdown"
          echo "- ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰"


      - name: ${{ matrix.cluster }} í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°
        run: |
          echo "Wait for application health check on ${{ matrix.cluster }}"
          echo "- HTTP health endpoint í™•ì¸"
          echo "- ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸"
          echo "- ë¡œê·¸ ëª¨ë‹ˆí„°ë§"

      - name: ${{ matrix.cluster }} ë°°í¬ ì™„ë£Œ í™•ì¸
        run: echo "Verify deployment success on ${{ matrix.cluster }}"

  # ì „ì²´ ë°°í¬ ì™„ë£Œ í›„ ìµœì¢… ê²€ì¦
  post-deploy-verification:
    needs: [ build-and-push-ecr, rolling-deploy ]
    if: needs.rolling-deploy.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: ì „ì²´ í´ëŸ¬ìŠ¤í„° ë™ì‹œ í—¬ìŠ¤ì²´í¬
        run: echo "Health check both clusters simultaneously"
      - name: ë¡œë“œë°¸ëŸ°ì„œ ìƒíƒœ í™•ì¸
        run: echo "Check load balancer status and traffic distribution"
      - name: ë°°í¬ ì„±ê³µ ì•Œë¦¼
        run: |
          echo "Send deployment success notification"
          echo "- Slack/Teams ì•Œë¦¼"
          echo "- ë°°í¬ëœ ì´ë¯¸ì§€ íƒœê·¸: ${{ needs.build-and-push-ecr.outputs.image_tag }}"
          echo "- ë°°í¬ ì™„ë£Œ ì‹œê°„ ê¸°ë¡"


  # ë°°í¬ ì‹¤íŒ¨ ì‹œ ìë™ ë¡¤ë°±
  rollback-on-failure:
    needs: [ build-and-push-ecr, rolling-deploy ]
    if: failure() && needs.rolling-deploy.result == 'failure'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        cluster: [ 'product-cluster-1', 'product-cluster-2' ]
      max-parallel: 2  # ë¡¤ë°±ì€ ë³‘ë ¬ë¡œ ë¹ ë¥´ê²Œ ì‹¤í–‰
    steps:
      - name: 1Password ì¸ì¦ ì„¤ì • (ë¡¤ë°±ìš©)
        run: echo "Configure 1Password for rollback on ${{ matrix.cluster }}"
      - name: ${{ matrix.cluster }} ë¡¤ë°± ì‹œì‘
        run: echo "Starting rollback on ${{ matrix.cluster }}"
      - name: ${{ matrix.cluster }} ì´ì „ ì´ë¯¸ì§€ë¡œ ë³µêµ¬
        run: |
          echo "Rollback to previous image on ${{ matrix.cluster }}"
          echo "- ì‹¤íŒ¨í•œ ì»¨í…Œì´ë„ˆ ì¤‘ì§€"
          echo "- ì´ì „ ì´ë¯¸ì§€ë¡œ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘"
          echo "- í—¬ìŠ¤ì²´í¬ í™•ì¸"
      - name: ë¡¤ë°± ì‹¤íŒ¨ ì•Œë¦¼
        run: |
          echo "Send rollback notification"
          echo "- ì‹¤íŒ¨ ì›ì¸ ë¶„ì„"
          echo "- ê¸´ê¸‰ ëŒ€ì‘ ì•Œë¦¼"
          echo "- ë¡¤ë°± ìƒíƒœ ë³´ê³ "
