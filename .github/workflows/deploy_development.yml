# act workflow_dispatch -W .github/workflows/deploy_development.yml --secret-file .secrets --container-architecture linux/arm64
name: Deploy to Development

on:
  workflow_dispatch:
  pull_request:
    types: [ closed ]
    branches:
      - dev

concurrency:
  group: "deploy-development"
  cancel-in-progress: true

env:
  ORACLE_ENV_FILE: git.environment-variables/deploy/oracle/application-node-1.env
  ORACLE_SSH_KEY_FILE: git.environment-variables/deploy/oracle/keys/node-1.pem
  AWS_ECR_ENV_FILE: git.environment-variables/deploy/aws/ecr-properties.env
  APP_ENV_FILE: git.environment-variables/application.springboot/.env.dev

jobs:
  build-and-push:
    # PR ë³‘í•© ì‹œì—ë§Œ ì‹¤í–‰
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.build-image.outputs.image_tag }}
      registry: ${{ steps.build-image.outputs.registry }}
    steps:
      - name: Checkout code with submodules
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.GIT_ACCESS_TOKEN }}

      - name: Gradle ìºì‹± ì„¤ì •
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: AWS ECR í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
        env:
          ENV_FILE: ${{ env.AWS_ECR_ENV_FILE }}
        run: |
          echo "ğŸ“„ AWS ECR í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ë¡œë“œ ì¤‘..."
          if [ ! -f "$ENV_FILE" ]; then
            echo "âŒ í™˜ê²½ë³€ìˆ˜ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $ENV_FILE"
            exit 1
          fi

          while IFS='=' read -r key value || [ -n "$key" ]; do
            [[ -z "$key" || "$key" == \#* ]] && continue

            # ê³µë°± ì œê±°
            key=$(echo "$key" | xargs)
            value=$(echo "$value" | xargs)

            # ë§ˆìŠ¤í‚¹
            echo "::add-mask::${value}"

            # ë³€ìˆ˜ëª… ë§¤í•‘
            case "$key" in
              ECR_ACCESS_KEY)
                echo "AWS_ACCESS_KEY_ID=${value}" >> $GITHUB_ENV
                echo "  âœ… AWS_ACCESS_KEY_ID ë¡œë“œë¨"
                ;;
              ECR_SECRET_ACCESS_KEY)
                echo "AWS_SECRET_ACCESS_KEY=${value}" >> $GITHUB_ENV
                echo "  âœ… AWS_SECRET_ACCESS_KEY ë¡œë“œë¨"
                ;;
              ECR_REGION)
                echo "AWS_REGION=${value}" >> $GITHUB_ENV
                echo "  âœ… AWS_REGION ë¡œë“œë¨"
                ;;
              ECR_REGISTRY)
                echo "ECR_REGISTRY=${value}" >> $GITHUB_ENV
                echo "  âœ… ECR_REGISTRY ë¡œë“œë¨"
                ;;
            esac
          done < "$ENV_FILE"

          echo "âœ… AWS ECR í™˜ê²½ë³€ìˆ˜ ë¡œë“œ ì™„ë£Œ"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker Image
        id: build-image
        run: |
          # ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±
          IMAGE_TAG="${GITHUB_SHA:0:7}"
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "registry=${{ steps.login-ecr.outputs.registry }}" >> $GITHUB_OUTPUT

          # ì´ë¯¸ì§€ëª… ì„¤ì •
          FULL_IMAGE_NAME="${{ steps.login-ecr.outputs.registry }}/ecr-bottle-note-api:$IMAGE_TAG"

          # Docker ì´ë¯¸ì§€ ë¹Œë“œ (ë ˆì´ì–´ ìºì‹± í¬í•¨)
          docker buildx build --platform linux/arm64 \
            --provenance false \
            --cache-from type=registry,ref=${{ steps.login-ecr.outputs.registry }}/ecr-bottle-note-api:latest \
            --cache-to type=inline \
            -t $FULL_IMAGE_NAME \
            --load .
          echo "âœ… ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ: $FULL_IMAGE_NAME"

      - name: Push to ECR
        run: |
          IMAGE_TAG="${{ steps.build-image.outputs.image_tag }}"
          FULL_IMAGE_NAME="${{ steps.build-image.outputs.registry }}/ecr-bottle-note-api:$IMAGE_TAG"

          # ECRë¡œ ì´ë¯¸ì§€ í‘¸ì‹œ
          docker push $FULL_IMAGE_NAME
          echo "âœ… ì´ë¯¸ì§€ê°€ ECRì— í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤: $FULL_IMAGE_NAME"

  deploy-to-servers:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code with submodules
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.GIT_ACCESS_TOKEN }}
      - name: Oracle ì¸ìŠ¤í„´ìŠ¤ í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
        env:
          ENV_FILE: ${{ env.ORACLE_ENV_FILE }}
        run: |
          echo "ğŸ“„ Oracle ì¸ìŠ¤í„´ìŠ¤ í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ë¡œë“œ ì¤‘..."
          if [ ! -f "$ENV_FILE" ]; then
            echo "âŒ í™˜ê²½ë³€ìˆ˜ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $ENV_FILE"
            exit 1
          fi

          while IFS='=' read -r key value || [ -n "$key" ]; do
            [[ -z "$key" || "$key" == \#* ]] && continue

            # ë§ˆìŠ¤í‚¹
            echo "::add-mask::${value}"

            # GitHub í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •
            echo "${key}=${value}" >> $GITHUB_ENV
            echo "  âœ… $key ë¡œë“œë¨"
          done < "$ENV_FILE"

          echo "âœ… Oracle ì¸ìŠ¤í„´ìŠ¤ í™˜ê²½ë³€ìˆ˜ ë¡œë“œ ì™„ë£Œ"

      - name: SSH ê°œì¸í‚¤ íŒŒì¼ ë¡œë“œ
        env:
          KEY_FILE: ${{ env.ORACLE_SSH_KEY_FILE }}
        run: |
          echo "ğŸ”‘ SSH ê°œì¸í‚¤ íŒŒì¼ ë¡œë“œ ì¤‘..."

          if [ ! -f "$KEY_FILE" ]; then
            echo "âŒ SSH í‚¤ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $KEY_FILE"
            exit 1
          fi

          # SSH í‚¤ ì „ì²´ ë‚´ìš©ì„ í™˜ê²½ë³€ìˆ˜ë¡œ ì €ì¥
          SSH_KEY=$(cat "$KEY_FILE")

          # SSH í‚¤ì˜ ê° ì¤„ ë§ˆìŠ¤í‚¹
          echo "$SSH_KEY" | while IFS= read -r line; do
            [ -n "$line" ] && echo "::add-mask::${line}"
          done

          # ë©€í‹°ë¼ì¸ í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •
          {
            echo "SSH_PRIVATE_KEY<<EOF_SSH_KEY"
            cat "$KEY_FILE"
            echo "EOF_SSH_KEY"
          } >> $GITHUB_ENV

          echo "âœ… SSH ê°œì¸í‚¤ ë¡œë“œ ì™„ë£Œ"

      - name: AWS ECR í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
        env:
          ENV_FILE: ${{ env.AWS_ECR_ENV_FILE }}
        run: |
          echo "ğŸ“„ AWS ECR í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ë¡œë“œ ì¤‘..."
          if [ ! -f "$ENV_FILE" ]; then
            echo "âŒ í™˜ê²½ë³€ìˆ˜ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $ENV_FILE"
            exit 1
          fi

          while IFS='=' read -r key value || [ -n "$key" ]; do
            [[ -z "$key" || "$key" == \#* ]] && continue

            # ê³µë°± ì œê±°
            key=$(echo "$key" | xargs)
            value=$(echo "$value" | xargs)

            # ë§ˆìŠ¤í‚¹
            echo "::add-mask::${value}"

            # ë³€ìˆ˜ëª… ë§¤í•‘
            case "$key" in
              ECR_ACCESS_KEY)
                echo "AWS_ACCESS_KEY_ID=${value}" >> $GITHUB_ENV
                echo "  âœ… AWS_ACCESS_KEY_ID ë¡œë“œë¨"
                ;;
              ECR_SECRET_ACCESS_KEY)
                echo "AWS_SECRET_ACCESS_KEY=${value}" >> $GITHUB_ENV
                echo "  âœ… AWS_SECRET_ACCESS_KEY ë¡œë“œë¨"
                ;;
              ECR_REGION)
                echo "AWS_REGION=${value}" >> $GITHUB_ENV
                echo "  âœ… AWS_REGION ë¡œë“œë¨"
                ;;
              ECR_REGISTRY)
                echo "ECR_REGISTRY=${value}" >> $GITHUB_ENV
                echo "  âœ… ECR_REGISTRY ë¡œë“œë¨"
                ;;
            esac
          done < "$ENV_FILE"

          echo "âœ… AWS ECR í™˜ê²½ë³€ìˆ˜ ë¡œë“œ ì™„ë£Œ"

      - name: ì• í”Œë¦¬ì¼€ì´ì…˜ í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ì¤€ë¹„
        id: prepare-app-env
        run: |
          APP_ENV_CONTENT=$(cat "${{ env.APP_ENV_FILE }}" | base64 -w 0)
          echo "content=$APP_ENV_CONTENT" >> $GITHUB_OUTPUT

      - name: Copy compose file to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ env.INSTANCE_NETWORK_PUBLIC_IP }}
          port: ${{ env.INSTANCE_NETWORK_PORT }}
          username: ${{ env.INSTANCE_HOST_USERNAME }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          source: "compose/product-api.dev.yml"
          target: "~/"

      - name: Deploy to Dev Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.INSTANCE_NETWORK_PUBLIC_IP }}
          port: ${{ env.INSTANCE_NETWORK_PORT }}
          username: ${{ env.INSTANCE_HOST_USERNAME }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          script: |
            # AWS ìê²© ì¦ëª… ì„¤ì •
            aws configure set aws_access_key_id "${{ env.AWS_ACCESS_KEY_ID }}"
            aws configure set aws_secret_access_key "${{ env.AWS_SECRET_ACCESS_KEY }}"
            aws configure set region "${{ env.AWS_REGION }}"

            # ECR ë ˆì§€ìŠ¤íŠ¸ë¦¬ URL ê°€ì ¸ì˜¤ê¸°
            ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
            ECR_REGISTRY="${ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"

            # ECR ë¡œê·¸ì¸
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin $ECR_REGISTRY

            # ì´ë¯¸ì§€ ì •ë³´ ì„¤ì •
            IMAGE_TAG="${{ needs.build-and-push.outputs.image_tag }}"
            ECR_REPOSITORY="ecr-bottle-note-api"
            FULL_IMAGE_NAME="$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

            echo "ë‹¤ìš´ë¡œë“œí•  ì´ë¯¸ì§€: $FULL_IMAGE_NAME"

            # ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
            docker pull $FULL_IMAGE_NAME

            # ë‹¤ìš´ë¡œë“œ í™•ì¸
            docker images | grep $ECR_REPOSITORY

            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ì„¤ì • (ì„œë¸Œëª¨ë“ˆì—ì„œ ê°€ì ¸ì˜´)
            echo "${{ steps.prepare-app-env.outputs.content }}" | base64 -d > ~/compose/.bottlenote.development.ENV

            # ê°œë°œ ë¡œê·¸ ì‚­ì œ
            sudo rm -f /var/log/bottle-note/application-dev*

            # í™˜ê²½ë³€ìˆ˜ export (docker-composeì—ì„œ ì‚¬ìš©)
            export FULL_IMAGE_NAME="$FULL_IMAGE_NAME"
            export GIT_BRANCH="${{ github.ref_name }}"
            export GIT_COMMIT="${{ github.sha }}"
            export BUILD_TIME="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"

            # docker-composeë¡œ ë°°í¬ (ìë™ìœ¼ë¡œ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ êµì²´)
            docker-compose -f ~/compose/product-api.dev.yml up -d --force-recreate

            # ì»¨í…Œì´ë„ˆ ì‹¤í–‰ í™•ì¸
            docker-compose -f ~/compose/product-api.dev.yml ps

            echo "ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ëª¨ë“  Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì¤‘..."
            docker system prune -f
            docker image prune -a -f --filter "until=24h"
