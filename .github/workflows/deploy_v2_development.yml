name: deploy v2 development

on:
  workflow_dispatch:
  workflow_run:
    workflows: [ "product ci pipeline" ]
    types:
      - completed
    branches:
      - main

concurrency:
  group: "deploy-development"
  cancel-in-progress: true

jobs:
  prepare-build:
    runs-on: ubuntu-24.04-arm
    outputs:
      short-sha: ${{ steps.versions.outputs.short-sha }}
      product-image-tag: ${{ steps.versions.outputs.product-image-tag }}
      admin-image-tag: ${{ steps.versions.outputs.admin-image-tag }}
    steps:
      - name: checkout code with submodules
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.GIT_ACCESS_TOKEN }}

      - name: setup jdk
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: setup gradle cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: generate image tags
        id: versions
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          echo "short-sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "product-image-tag=product_${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "admin-image-tag=admin_${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "Commit SHA: $SHORT_SHA"

      - name: build both modules
        run: |
          ./gradlew :bottlenote-product-api:build :bottlenote-admin-api:build \
            -x test -x asciidoctor --build-cache --parallel

      - name: upload product jar
        uses: actions/upload-artifact@v4
        with:
          name: product-jar
          path: bottlenote-product-api/build/libs/bottlenote-product-api.jar
          retention-days: 1

      - name: upload admin jar
        uses: actions/upload-artifact@v4
        with:
          name: admin-jar
          path: bottlenote-admin-api/build/libs/bottlenote-admin-api.jar
          retention-days: 1

  build-product-image:
    needs: prepare-build
    runs-on: ubuntu-24.04-arm
    outputs:
      image-digest: ${{ steps.build.outputs.image-digest }}
    steps:
      - name: checkout code with submodules
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.GIT_ACCESS_TOKEN }}

      - name: download product jar
        uses: actions/download-artifact@v4
        with:
          name: product-jar
          path: bottlenote-product-api/build/libs/

      - name: build and push to registry
        id: build
        uses: ./.github/actions/docker-build-push
        with:
          registry-url: ${{ secrets.REGISTRY_ADDRESS }}
          registry-username: ${{ secrets.REGISTRY_USERNAME }}
          registry-password: ${{ secrets.REGISTRY_PASSWORD }}
          image-name: bottlenote-product-api
          image-tag: ${{ needs.prepare-build.outputs.product-image-tag }}
          additional-tags: product_latest_development
          dockerfile: Dockerfile
          context: .
          platforms: linux/arm64
          cache-scope: product-development
          image-title: "BottleNote Product API"
          image-description: "BottleNote Product API Server (Development)"
          image-vendor: "BottleNote"
          image-authors: "BottleNote Team"
          sign-image: 'true'
          cosign-key-path: 'git.environment-variables/storage/docker-registry/cosign.key'
          cosign-password: ${{ secrets.COSIGN_PASSWORD }}

  build-admin-image:
    needs: prepare-build
    runs-on: ubuntu-24.04-arm
    outputs:
      image-digest: ${{ steps.build.outputs.image-digest }}
    steps:
      - name: checkout code with submodules
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.GIT_ACCESS_TOKEN }}

      - name: download admin jar
        uses: actions/download-artifact@v4
        with:
          name: admin-jar
          path: bottlenote-admin-api/build/libs/

      - name: build and push to registry
        id: build
        uses: ./.github/actions/docker-build-push
        with:
          registry-url: ${{ secrets.REGISTRY_ADDRESS }}
          registry-username: ${{ secrets.REGISTRY_USERNAME }}
          registry-password: ${{ secrets.REGISTRY_PASSWORD }}
          image-name: bottlenote-admin-api
          image-tag: ${{ needs.prepare-build.outputs.admin-image-tag }}
          additional-tags: admin_latest_development
          dockerfile: Dockerfile-admin
          context: .
          platforms: linux/arm64
          cache-scope: admin-development
          image-title: "BottleNote Admin API"
          image-description: "BottleNote Admin API Server (Development)"
          image-vendor: "BottleNote"
          image-authors: "BottleNote Team"
          sign-image: 'true'
          cosign-key-path: 'git.environment-variables/storage/docker-registry/cosign.key'
          cosign-password: ${{ secrets.COSIGN_PASSWORD }}

  update-development:
    needs: [prepare-build, build-product-image, build-admin-image]
    runs-on: ubuntu-latest
    steps:
      - name: checkout code with submodules
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.GIT_ACCESS_TOKEN }}

      - name: setup kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: update development image tags
        run: |
          PRODUCT_TAG="${{ needs.prepare-build.outputs.product-image-tag }}"
          ADMIN_TAG="${{ needs.prepare-build.outputs.admin-image-tag }}"
          REGISTRY="${{ secrets.REGISTRY_ADDRESS }}"

          echo "Updating development image tags:"
          echo "  Product: $PRODUCT_TAG"
          echo "  Admin: $ADMIN_TAG"

          cd git.environment-variables
          git checkout main

          cd deploy/overlays/development
          kustomize edit set image \
            bottlenote-product-api=${REGISTRY}/bottlenote-product-api:${PRODUCT_TAG} \
            bottlenote-admin-api=${REGISTRY}/bottlenote-admin-api:${ADMIN_TAG}

          echo "development kustomization.yaml updated"

      - name: commit and push with retry
        run: |
          cd git.environment-variables

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add deploy/overlays/development/kustomization.yaml

          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "chore(dev): update development image tags (${{ needs.prepare-build.outputs.short-sha }})

          Product: ${{ needs.prepare-build.outputs.product-image-tag }}
          Admin: ${{ needs.prepare-build.outputs.admin-image-tag }}

          Updated by GitHub Actions
          Commit: ${{ github.sha }}
          Workflow: ${{ github.workflow }}"

          for i in {1..5}; do
            git pull --rebase origin main && git push origin main && break
            echo "Push failed, retry $i/5..."
            sleep $((i * 2))
          done

          echo "Development deployment triggered"
